# Симуляция AzeriMetro

Этот проект представляет собой C++ симуляцию системы Бакинского метрополитена. Он использует многопоточность для моделирования одновременной работы поездов на различных линиях, определенных в конфигурационном файле JSON.

## Особенности

* **Многопоточная симуляция:** Моделирует одновременное движение нескольких поездов (`std::thread`).
* **Конфигурация через JSON:** Определяет станции, линии (Main, Purple, Lime), маршруты и характеристики линий (`metro_config.json`). Использует библиотеку nlohmann/json.
* **Синхронизация:** Применяет `std::mutex` и `std::timed_mutex` для управления доступом к станциям и участкам пути.
* **Детальное моделирование:** Представляет ключевые компоненты метро через классы (`MetroSystem`, `MetroLine`, `MetroStation`, `Train`).
* **Двустороннее/Одностороннее движение:** Поддерживает оба типа движения в зависимости от конфигурации линии.
* **Станционная логика:** Моделирует остановки, время в пути, занятость путей в разных направлениях.
* **Случайные события:** Включает логику для поездок в депо "Бакмиль".

## Структура Метро (в симуляции)

* **Конфигурация (`metro_config.json`):** Определяет:
    * `stations`: Список станций с `id` и `name`.
    * `lines`: Список линий (Main, Purple, Lime), каждая с:
        * `name`, `isOneWay` (двустороннее/одностороннее), `isPurple`.
        * Маршрутами (`initial`, `green`, `red`, `bakmil_from_green`, `bakmil_from_red`), заданными как списки ID станций. Линия "Main" имеет отдельные "красный" и "зеленый" маршруты.
* **Связи станций (`MetroStation`):** Каждая станция хранит указатели (`std::shared_ptr`) на следующую (`nextStations`) и предыдущую (`prevStations`) станции для каждого типа маршрута. Это формирует структуру связных списков для путей движения поездов. Станции также имеют флаги `isOccupiedForward` и `isOccupiedBackward` и мьютекс `std::timed_mutex`.
* **Реестр станций (`Utils`):** Глобальный `stationRegistry` (`std::unordered_map<int, std::shared_ptr<MetroStation>>`) обеспечивает централизованный доступ к объектам станций по их ID во время построения маршрутов в `MetroLine`.

## Логика Поездов (`Train`)

* **Движение (`move`):** Основная функция перемещения между станциями.
    * **Блокировка:** Пытается заблокировать мьютекс станции (`std::timed_mutex`). Если не удается в течение 10 секунд, попытка считается неудачной.
    * **Проверка занятости:** Проверяет флаги `isOccupiedForward` или `isOccupiedBackward` (в зависимости от направления `isForward` и флага станции `isOneWay`). Если путь занят, поезд ожидает (до 100 попыток с интервалом 100 мс), временно освобождая мьютекс станции для других потоков.
    * **Остановка:** Имитирует остановку на станции на время `stop_time` (константа, равная 3 условным единицам времени, вероятно, секундам).
    * **Время в пути:** Имитирует время движения до следующей станции (`travel_time`, константа, равная 3).
* **Маршруты (`run`, `run_purple`, `run_lime`):**
    * `run` (Линия Main): Симулирует движение поезда вперед-назад между конечными станциями ("Azi Aslanov" и "Dyarnyagyul"/"Icheri Sheher") заданное количество циклов (`num_cycles`, в `main.cpp` = 5). На конечной ("Dyarnyagyul" или "Icheri Sheher") с вероятностью 20% поезд может отправиться в "Бакмиль". Из этих 20%: с вероятностью 25% это поездка на ремонт (поток поезда завершается), иначе – обычная поездка (поезд ожидает `bakmil_wait_time` = 5 и возвращается).
    * `run_purple` (Фиолетовая линия): Поезда курсируют между станциями [23, 24, 25, 26] (Hojasan..8 November). Выбор конечной ("Hojasan" или "Avtovagzal") перед возвращением в депо ("Hojasan Depo") зависит от четности общего атомарного счетчика поездов (`train_counter`). Симуляция для этой линии длится 10 циклов.
    * `run_lime` (Салатовая линия): Симулирует челночное движение между двумя станциями [27, 28] ("Jafar Jabbarly" и "Khatai") в течение 20 циклов.
* **Синхронизация:** Используется общий `print_mutex` для вывода в консоль.
* **Случайность:** `std::random_device` и `std::mt19937` используются для определения вероятности событий на линии Main.

## Интересные Особенности Симуляции

* **Время:** Время остановки (`stop_time`) и время в пути (`travel_time`) между станциями фиксированы и равны 3 условным единицам. Время ожидания на станции "Бакмиль" (`bakmil_wait_time`) равно 5.
* **Особая роль станции "Бакмиль":** В симуляции "Бакмиль" служит не только начальной и конечной точкой для поездов Главной линии, но и местом случайного перенаправления. Поезда этой линии имеют 20% шанс отправиться в "Бакмиль" с конечных станций; из них 25% поездок имитируют "ремонт" (поезд удаляется из симуляции). В остальных 75% случаев это "обычная поездка": поезд прибывает в "Бакмиль", выводится сообщение о том, что "машинист переходит в хвостовой вагон" (`the driver moves to the rear carriage`), поезд ожидает 5 единиц времени (`bakmil_wait_time`), после чего возвращается на основной маршрут для продолжения работы. Для заезда в "Бакмиль" используются специальные маршруты из конфигурации.
* **Конфигурация линий:** Система моделирует 3 линии с разными характеристиками: сложную Главную линию с разветвлениями, стандартную Фиолетовую и короткую однопутную Салатовую.
* **Вероятностные события:** На Главной линии реализована 20% вероятность отклонения от маршрута в сторону "Бакмиль" и дальнейшая 25% вероятность "ремонта" (выход из симуляции).
* **Координация поездов:** На Фиолетовой линии используется атомарный счетчик для распределения поездов между двумя конечными пунктами перед возвращением в депо.
* **Запуск:** Симуляция стартует с предопределенным количеством поездов: 6 на Главной линии, 4 на Фиолетовой и 2 на Салатовой.
* **Односторонние участки:** Станция "Hojasan" принудительно устанавливается как односторонняя в коде (`MetroSystem.cpp`), независимо от настроек линии.
* **Именование:** Проект назван `AzeriMetro` в `CMakeLists.txt`, что указывает на моделирование Бакинского метро.

## Требования

* Компилятор с поддержкой C++20
* CMake (версия 3.10 или выше)

## Сборка

1.  Убедитесь, что у вас установлен CMake и компилятор C++20.
2.  Создайте директорию для сборки:
    ```bash
    mkdir build
    cd build
    ```
3.  Запустите CMake для конфигурации проекта:
    ```bash
    cmake ..
    ```
4.  Соберите проект:
    ```bash
    cmake --build .
    ```
    Будет создан исполняемый файл `AzeriMetro` (или `AzeriMetro.exe` в Windows) в директории `build`.

## Запуск

1.  Убедитесь, что файл `metro_config.json` находится в той же директории, что и исполняемый файл.
2.  Запустите исполняемый файл из директории `build`:
    ```bash
    ./AzeriMetro
    ```
    Или в Windows:
    ```cmd
    .\AzeriMetro.exe
    ```
Симуляция начнется, считывая конфигурацию и запуская потоки поездов. В консоль будет выводиться информация о движении поездов и попытках синхронизации.
